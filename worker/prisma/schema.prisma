// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTH
// ============================================

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  CASHIER
  WAREHOUSE_STAFF
}

model User {
  id           String   @id @default(cuid())
  name         String
  username     String   @unique
  passwordHash String   @map("password_hash")
  email        String?  @unique
  phone        String?
  role         UserRole @default(CASHIER)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  outletUsers            OutletUser[]
  createdPurchaseOrders  PurchaseOrder[] @relation("CreatedByUser")
  receivedPurchaseOrders PurchaseOrder[] @relation("ReceivedByUser")
  posOrders              PosOrder[]
  stockMovements         StockMovement[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

enum OutletRole {
  MANAGER
  CASHIER
  WAREHOUSE_STAFF
}

model OutletUser {
  id               String     @id @default(cuid())
  userId           String     @map("user_id")
  outletId         String     @map("outlet_id")
  outletRole       OutletRole @map("outlet_role")
  isDefaultForUser Boolean    @default(false) @map("is_default_for_user")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  outlet Outlet @relation(fields: [outletId], references: [id], onDelete: Cascade)

  @@unique([userId, outletId])
  @@index([userId])
  @@index([outletId])
  @@map("outlet_users")
}

// ============================================
// OUTLETS & LOCATIONS
// ============================================

model Outlet {
  id                 String   @id @default(cuid())
  name               String
  code               String   @unique
  addressLine1       String?  @map("address_line1")
  addressLine2       String?  @map("address_line2")
  city               String?
  state              String?
  postalCode         String?  @map("postal_code")
  country            String?
  phone              String?
  defaultPriceTierId String?  @map("default_price_tier_id")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  defaultPriceTier  PriceTier?         @relation(fields: [defaultPriceTierId], references: [id], onDelete: SetNull)
  outletUsers       OutletUser[]
  warehouses        Warehouse[]
  posRegisters      PosRegister[]
  purchaseOrders    PurchaseOrder[]
  posOrders         PosOrder[]
  stockMovements    StockMovement[]
  productPriceTiers ProductPriceTier[]

  @@index([isActive])
  @@map("outlets")
}

enum WarehouseType {
  CENTRAL
  OUTLET
}

model Warehouse {
  id           String        @id @default(cuid())
  outletId     String?       @map("outlet_id")
  name         String
  code         String        @unique
  addressLine1 String?       @map("address_line1")
  addressLine2 String?       @map("address_line2")
  city         String?
  state        String?
  postalCode   String?       @map("postal_code")
  country      String?
  type         WarehouseType @default(OUTLET)
  isDefault    Boolean       @default(false) @map("is_default")
  isActive     Boolean       @default(true) @map("is_active")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  outlet             Outlet?         @relation(fields: [outletId], references: [id], onDelete: SetNull)
  inventories        Inventory[]
  purchaseOrders     PurchaseOrder[]
  posOrders          PosOrder[]
  stockMovementsFrom StockMovement[] @relation("FromWarehouse")
  stockMovementsTo   StockMovement[] @relation("ToWarehouse")

  @@index([outletId])
  @@index([isActive])
  @@map("warehouses")
}

model PosRegister {
  id        String   @id @default(cuid())
  outletId  String   @map("outlet_id")
  name      String
  code      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  outlet    Outlet     @relation(fields: [outletId], references: [id], onDelete: Cascade)
  posOrders PosOrder[]

  @@unique([outletId, code])
  @@index([outletId])
  @@map("pos_registers")
}

// ============================================
// PRICING
// ============================================

model PriceTier {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  productPriceTiers ProductPriceTier[]
  customers         Customer[]
  outlets           Outlet[]
  posOrderItems     PosOrderItem[]

  @@map("price_tiers")
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  barcode     String?  @unique
  name        String
  description String?  @db.Text
  category    String?
  unit        String   @default("pcs")
  basePrice   Decimal  @map("base_price") @db.Decimal(10, 2)
  costPrice   Decimal? @map("cost_price") @db.Decimal(10, 2)
  taxRate     Decimal? @map("tax_rate") @db.Decimal(5, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  priceTiers         ProductPriceTier[]
  inventories        Inventory[]
  purchaseOrderItems PurchaseOrderItem[]
  posOrderItems      PosOrderItem[]
  stockMovements     StockMovement[]

  @@index([isActive])
  @@index([category])
  @@index([name])
  @@map("products")
}

model ProductPriceTier {
  id          String   @id @default(cuid())
  productId   String   @map("product_id")
  priceTierId String   @map("price_tier_id")
  outletId    String?  @map("outlet_id")
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  priceTier PriceTier @relation(fields: [priceTierId], references: [id], onDelete: Cascade)
  outlet    Outlet?   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  @@unique([productId, priceTierId, outletId])
  @@index([productId])
  @@index([priceTierId])
  @@index([outletId])
  @@map("product_price_tiers")
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id           String   @id @default(cuid())
  name         String
  email        String?  @unique
  phone        String?
  addressLine1 String?  @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String?
  state        String?
  postalCode   String?  @map("postal_code")
  country      String?
  priceTierId  String?  @map("price_tier_id")
  isMember     Boolean  @default(false) @map("is_member")
  notes        String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  priceTier PriceTier? @relation(fields: [priceTierId], references: [id], onDelete: SetNull)
  posOrders PosOrder[]

  @@index([email])
  @@index([phone])
  @@index([name])
  @@index([priceTierId])
  @@map("customers")
}

// ============================================
// INVENTORY
// ============================================

model Inventory {
  id             String   @id @default(cuid())
  productId      String   @map("product_id")
  warehouseId    String   @map("warehouse_id")
  quantityOnHand Decimal  @default(0) @map("quantity_on_hand") @db.Decimal(10, 2)
  minimumStock   Decimal  @default(0) @map("minimum_stock") @db.Decimal(10, 2)
  maximumStock   Decimal? @map("maximum_stock") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([productId, warehouseId])
  @@index([warehouseId])
  @@index([quantityOnHand])
  @@map("inventories")
}

// ============================================
// SUPPLIERS & PROCUREMENT
// ============================================

model Supplier {
  id            String   @id @default(cuid())
  name          String
  contactPerson String?  @map("contact_person")
  email         String?
  phone         String?
  addressLine1  String?  @map("address_line1")
  addressLine2  String?  @map("address_line2")
  city          String?
  state         String?
  postalCode    String?  @map("postal_code")
  country       String?
  taxNumber     String?  @map("tax_number")
  notes         String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrders PurchaseOrder[]

  @@index([isActive])
  @@index([name])
  @@map("suppliers")
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id               String              @id @default(cuid())
  supplierId       String              @map("supplier_id")
  warehouseId      String              @map("warehouse_id")
  outletId         String              @map("outlet_id")
  status           PurchaseOrderStatus @default(DRAFT)
  orderNumber      String              @unique @map("order_number")
  orderDate        DateTime            @map("order_date")
  expectedDate     DateTime?           @map("expected_date")
  totalAmount      Decimal             @map("total_amount") @db.Decimal(12, 2)
  notes            String?             @db.Text
  createdByUserId  String              @map("created_by_user_id")
  receivedByUserId String?             @map("received_by_user_id")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  // Relations
  supplier   Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  warehouse  Warehouse           @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  outlet     Outlet              @relation(fields: [outletId], references: [id], onDelete: Restrict)
  createdBy  User                @relation("CreatedByUser", fields: [createdByUserId], references: [id], onDelete: Restrict)
  receivedBy User?               @relation("ReceivedByUser", fields: [receivedByUserId], references: [id], onDelete: Restrict)
  items      PurchaseOrderItem[]

  @@index([supplierId])
  @@index([warehouseId])
  @@index([outletId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String   @id @default(cuid())
  purchaseOrderId  String   @map("purchase_order_id")
  productId        String   @map("product_id")
  quantityOrdered  Decimal  @map("quantity_ordered") @db.Decimal(10, 2)
  quantityReceived Decimal  @default(0) @map("quantity_received") @db.Decimal(10, 2)
  unitCost         Decimal  @map("unit_cost") @db.Decimal(10, 2)
  lineTotal        Decimal  @map("line_total") @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

// ============================================
// STOCK MOVEMENTS
// ============================================

enum StockMovementType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
}

model StockMovement {
  id              String            @id @default(cuid())
  productId       String            @map("product_id")
  fromWarehouseId String?           @map("from_warehouse_id")
  toWarehouseId   String?           @map("to_warehouse_id")
  outletId        String            @map("outlet_id")
  type            StockMovementType
  quantity        Decimal           @db.Decimal(10, 2)
  reference       String?
  notes           String?           @db.Text
  createdByUserId String?           @map("created_by_user_id")
  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  product       Product    @relation(fields: [productId], references: [id], onDelete: Restrict)
  fromWarehouse Warehouse? @relation("FromWarehouse", fields: [fromWarehouseId], references: [id], onDelete: Restrict)
  toWarehouse   Warehouse? @relation("ToWarehouse", fields: [toWarehouseId], references: [id], onDelete: Restrict)
  outlet        Outlet     @relation(fields: [outletId], references: [id], onDelete: Restrict)
  createdBy     User?      @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([productId, createdAt])
  @@index([outletId, createdAt])
  @@index([type])
  @@map("stock_movements")
}

// ============================================
// POS / SALES
// ============================================

enum PosOrderStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

model PosOrder {
  id                  String         @id @default(cuid())
  outletId            String         @map("outlet_id")
  warehouseId         String         @map("warehouse_id")
  registerId          String?        @map("register_id")
  customerId          String?        @map("customer_id")
  cashierId           String         @map("cashier_id")
  orderNumber         String         @unique @map("order_number")
  status              PosOrderStatus @default(OPEN)
  paymentStatus       PaymentStatus  @default(UNPAID) @map("payment_status")
  subtotalAmount      Decimal        @map("subtotal_amount") @db.Decimal(12, 2)
  totalDiscountAmount Decimal        @default(0) @map("total_discount_amount") @db.Decimal(12, 2)
  totalTaxAmount      Decimal        @default(0) @map("total_tax_amount") @db.Decimal(12, 2)
  totalAmount         Decimal        @map("total_amount") @db.Decimal(12, 2)
  notes               String?        @db.Text
  createdAt           DateTime       @default(now()) @map("created_at")
  closedAt            DateTime?      @map("closed_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  // Relations
  outlet    Outlet         @relation(fields: [outletId], references: [id], onDelete: Restrict)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  register  PosRegister?   @relation(fields: [registerId], references: [id], onDelete: SetNull)
  customer  Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  cashier   User           @relation(fields: [cashierId], references: [id], onDelete: Restrict)
  items     PosOrderItem[]
  payments  Payment[]

  @@index([outletId, createdAt])
  @@index([status])
  @@index([status, createdAt]) // Analytics: getSalesTrend, getHourlySalesHeatmap
  @@index([status, outletId, createdAt]) // Analytics: filtered by outlet
  @@index([paymentStatus])
  @@index([customerId])
  @@index([cashierId])
  @@index([closedAt])
  @@map("pos_orders")
}

model PosOrderItem {
  id                   String   @id @default(cuid())
  posOrderId           String   @map("pos_order_id")
  productId            String   @map("product_id")
  quantity             Decimal  @db.Decimal(10, 2)
  unitPrice            Decimal  @map("unit_price") @db.Decimal(10, 2)
  discountAmount       Decimal  @default(0) @map("discount_amount") @db.Decimal(10, 2)
  taxAmount            Decimal  @default(0) @map("tax_amount") @db.Decimal(10, 2)
  lineTotal            Decimal  @map("line_total") @db.Decimal(12, 2)
  effectivePriceTierId String?  @map("effective_price_tier_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  posOrder           PosOrder   @relation(fields: [posOrderId], references: [id], onDelete: Cascade)
  product            Product    @relation(fields: [productId], references: [id], onDelete: Restrict)
  effectivePriceTier PriceTier? @relation(fields: [effectivePriceTierId], references: [id], onDelete: SetNull)

  @@index([posOrderId])
  @@index([productId])
  @@map("pos_order_items")
}

enum PaymentMethod {
  CASH
  CARD
  E_WALLET
  BANK_TRANSFER
}

model Payment {
  id         String        @id @default(cuid())
  posOrderId String        @map("pos_order_id")
  method     PaymentMethod
  amount     Decimal       @db.Decimal(12, 2)
  paidAt     DateTime      @map("paid_at")
  reference  String?
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  // Relations
  posOrder PosOrder @relation(fields: [posOrderId], references: [id], onDelete: Cascade)

  @@index([posOrderId])
  @@map("payments")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  eventType  String   @map("event_type")
  userId     String?  @map("user_id")
  outletId   String?  @map("outlet_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  payload    Json
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([eventType, createdAt])
  @@index([outletId, createdAt])
  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
